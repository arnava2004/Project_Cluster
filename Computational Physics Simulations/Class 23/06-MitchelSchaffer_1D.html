<!DOCTYPE html>
<html>
<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<!-- Header of the HTML file. Usually, all libraries and scripts are    -->
<!-- placed in this section of the HTML file.                           -->
<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<head>
    <!--    MathJax is used to show equations! 
            The following section sets up the MathJax environment.  -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      displayAlign: "left",
      TeX :{
        style: {
            "padding": "10px 20px",
        }

      }
    });
    </script>
    <!--    The following line imports the MathJax library          -->
    <script 
        type="text/javascript" async 
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_CHTML">
    </script>
    <!-- including AkPlot.js for plotting purposes. -->
    <script src='AkPlot.js'></script>
</head>

<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<!-- Main body of the html file                                         -->
<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<body onload='init();'> <!--    when the HTML file is loaded the function 
                                init() is executed.                     -->
<h1>Mitchel-Schaffer Model</h1>   <!-- Header of the page             -->
<!-- The following canvas is used for plotting -->
<canvas id="c0"             
        width="500" 
        height="400" 
        style='border:2px solid #eeeeee , display:"none"' >
</canvas></br>

<input type='button' onclick='init();' value='Initialize'></input>
<input type='button' onclick='running=!running;' value='Run/Stop'></input></br>
<p>Boundary conditions are:</p>
<form>
  <input type="radio" name="bc" id='periodic' value="periodic">Periodic<br>
  <input type="radio" name="bc" id='zeroflux' value="zero-flux" checked>Zero Flux<br>
</form></br>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<!-- the table of values                                                -->
<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<table>
    <tr>
        <td>$\tau_{in}$</td>
        <td><input  type='number' id='tau_in' 
                    step=0.01 value=0.01 onchange='init()'></td>
    </tr>
    <tr>
        <td>$\tau_{out}$</td>
        <td><input  type='number' id='tau_out' 
                    step=0.01 value=0.4 onchange='init()'></td>
    </tr>

    <tr>
        <td>$\tau_{open}$</td>
        <td><input  type='number' id='tau_open' 
                    step=0.01 value=195.0 
                    onchange='init()'></td>
    </tr>
    <tr>
        <td>$\tau_{close}$</td>
        <td><input  type='number' id='tau_close' 
                    step=0.01 value=93.81 
                    onchange='init()'></td>
    </tr>
    <tr>
        <td>$v_{gate}$</td>
        <td><input  type='number' id='v_gate' 
                    step=0.01 value=0.1 
                    onchange='init()'></td>
    </tr>
    <tr>
        <td>$v_0$</td>
        <td><input  type='number' id='v0' 
                    step=0.01 value=0.0 
                    ></td>
    </tr>
    <tr>
        <td>$h_0$</td>
        <td><input  type='number' id='h0' 
                    step=0.01 value=0 
                    ></td>
    </tr>
    <tr>
        <td>$\Delta t$</td>
        <td><input  type='number' id='dt' 
                    value=0.01 
                    onchange='init()'></td>
    </tr>
    <tr>
        <td>$\Delta x$</td><td>
            <input  type='number' id='dx' 
                    value=0.05 
                    onchange='init()'></td>
        </td>
    </tr>
    <tr>
        <td>$L$</td><td>
            <input  type='number' id='L' 
                    value=10.0 
                    onchange='init()'></td>
        </td>
    </tr>
    <tr>
        <td>wait</td>
        <td><input  type='number' id='wait' value=5 ></td>
    </tr>
</table>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<!-- Computational script                                               -->
<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<script>

function getNum(id){ /* gets the number from the GUI using the id */
    return eval(document.getElementById(id).value) ;
}

/*========================================================================
 * creating the map
 *========================================================================
 */ 
var c0 = document.getElementById('c0') ;
var plt0 = new Plot(c0) ;
plt0.margins.left = 70 ;
plt0.margins.right = 20 ;
plt0.margins.top=10 ;
plt0.xlabel = 'x' ;
plt0.ylabel = '';
plt0.yticks.precision = 2 ;
plt0.xticks.precision = 2 ;
plt0.xticks.noDivs = 5 ;

ur = {min:-1., max:1.5} ;
vr = {min:-2, max:2} ;
plt0.xlimits = [0.,getNum('L')] ;
plt0.ylimits = [ur.min,ur.max] ;
plt0.legend = 'on' ;
plt0.grid = 'on' ;
plt0.legend.location = [c0.width-60,20] ;
plt0.init() ;
function click(e){
     for(var i=0; i<N; i++){
         if (Math.abs(x[i]-e.x)<0.1){
             v[i]=getNum('v0') ;
             h[i]=getNum('h0') ;
         }
     }
}
plt0.addClickListener(click) ;

var vcrv = plt0.addCurveFromArrays(); vcrv.name = 'v' ;
var hcrv = plt0.addCurveFromArrays(); hcrv.name = 'h' ;

var tau_in, tau_out, tau_open, tau_close,v_gate ;
var h, v, x, v0 , h0, dt ;
var lap_v ;
var diffCoef ;
var L, dx, N ;
var running=false ;

function init(){
    tau_in = getNum('tau_in') ;
    tau_out = getNum('tau_out') ;
    tau_open = getNum('tau_open') ;
    tau_close = getNum('tau_close') ;
    v_gate = getNum('v_gate') ;
    dt = getNum('dt') ;
    dx = getNum('dx') ;
    L  = getNum('L' ) ;
    plt0.xlimits = [0,L] ;
    plt0.init() ;
    N  = Math.floor(L/dx)+1. ;
    
    h  = new Float32Array(N) ;
    v  = new Float32Array(N) ;
    x  = new Float32Array(N) ;
    lap_v = new Float32Array(N) ;

    for(var i=0; i<N; i++){
        x[i]= i*dx ;
        h[i]= 1 ;
        v[i]= 0 ;
    }
    diffCoef= 0.001171  ;
    vcrv.plot(x,v) ;
    hcrv.plot(x,h) ;
    run() ;
}
function run(){
    if(running){
        for(var jj=0; jj<40 ; jj++){

            // Calculating the boundary values
            if(document.getElementById('periodic').checked){
                lap_v[0] = (v[1]-2.*v[0]+v[N-2]) ;
                lap_v[N-1] = (v[N-2]-2.*v[N-1]+v[1]) ;
            }else{
                lap_v[0] = 2.*(v[1]-v[0]) ;
                lap_v[N-1] = 2.*(v[N-2]-v[N-1]) ;
            }
            for(var i=1;i<N-1;i++){
                lap_v[i] = v[i-1]-2.*v[i]+v[i+1] ;
            }

            var dv2dt, dh2dt ;
            for(var i=0; i<N; i++){
                dv2dt = lap_v[i]*diffCoef/(dx*dx) 
                    + h[i]*v[i]*(v[i]-v_gate)*(1.-v[i])/tau_in 
                    - (1.-h[i])*v[i]/tau_out ;
            if (v[i] <= v_gate )
                dh2dt = (1.-h[i])/tau_open ;
            else
                dh2dt = -h[i]/tau_close ;

                v[i] += dv2dt*dt ;
                h[i] += dh2dt*dt ;
            }
        }
    }
    vcrv.plot(x,v) ;
    hcrv.plot(x,h) ;
    requestAnimationFrame(run) ;
} ;

</script>
</body>
</html>
